{% extends 'base.html' %}
{% block content %}
<h1>Products</h1>

<form class="form-inline mb-3" method="get">
  <input type="text" class="form-control mr-2" name="q" placeholder="Search product across all websites..." value="{{ search_query }}" style="width: 400px;">
  <button type="submit" class="btn btn-info">üîç Live Search</button>
</form>

<div class="alert alert-info">
    <strong>üí° How it works:</strong> Enter a product name to search across Amazon, Flipkart, Myntra & Ajio simultaneously. Results will be sorted by price (low to high).
</div>

{% if products %}
<h3>Saved Products ({{ products|length }})</h3>
<div class="table-responsive">
  <table class="table table-striped table-hover">
    <thead class="thead-dark">
      <tr>
        <th>Name</th>
        <th>Site</th>
        <th>Latest Price (‚Çπ)</th>
        <th>Lowest Year Price (‚Çπ)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in products %}
      <tr>
        <td>{{ p.name|truncatechars:60 }}</td>
        <td><span class="badge badge-primary">{{ p.site }}</span></td>
        <td><strong class="text-success">‚Çπ{{ p.latest_price }}</strong></td>
        <td><strong class="text-info">‚Çπ{{ p.lowest_price }}</strong></td>
        <td>
          <a href="{{ p.url }}" target="_blank" class="btn btn-sm btn-primary" title="View Product">
            üîó View
          </a>
          {% if user.is_authenticated %}
            <button class="btn btn-sm btn-warning" data-toggle="modal" data-target="#alertModal{{ p.id }}" title="Set Price Alert">
              üîî Alert
            </button>
            <button class="btn btn-sm btn-danger" data-toggle="modal" data-target="#deleteModal{{ p.id }}" title="Delete Product">
              üóëÔ∏è Delete
            </button>
          {% else %}
            <a href="{% url 'login' %}" class="btn btn-sm btn-secondary">Login for alerts</a>
          {% endif %}
        </td>
      </tr>
      
      <!-- Alert Modal -->
      {% if user.is_authenticated %}
      <div class="modal fade" id="alertModal{{ p.id }}" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Set Price Alert</h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <form method="post" action="{% url 'set_alert' p.id %}">
              {% csrf_token %}
              <div class="modal-body">
                <p><strong>Product:</strong> {{ p.name|truncatechars:50 }}</p>
                <p><strong>Current Price:</strong> ‚Çπ{{ p.latest_price }}</p>
                <div class="form-group">
                  <label>Alert me when price drops below:</label>
                  <input type="number" step="0.01" name="target_price" class="form-control" placeholder="Enter target price" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-warning">Set Alert</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Delete Modal -->
      <div class="modal fade" id="deleteModal{{ p.id }}" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Delete Product</h5>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
              <p>Are you sure you want to delete this product?</p>
              <p><strong>{{ p.name }}</strong></p>
              <p class="text-danger"><small>This will also delete all price history and alerts for this product.</small></p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
              <a href="{% url 'delete_product' p.id %}" class="btn btn-danger">Yes, Delete</a>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="alert alert-warning">
    <strong>üì¶ No saved products yet.</strong> Use the search bar above to find products across all websites!
</div>
{% endif %}

{% endblock %}
